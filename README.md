# ModernMystic Tarot App

* Ruby version 2.4.2p198
* Rails version 5.1.4
* Codebase in Private Repo: https://bitbucket.org/annerichardson/tarot/
* Production App: https://modernmystic.herokuapp.com/

## The Rails App

This app provides tarot card readings based on the full 1909 Rider-Waite (RWS) deck and offers a few different reading spreads. Though the selection of cards for the readings is generated by a `.sample` in Ruby, it's mystic as all hell. ;) Go on, give it a try at [modernmystic.herokuapp.com](https://modernmystic.herokuapp.com/)

## The Terminal App

I made this app initially as a console app while in coding school at Tech Talent South (2015) because terminal apps make me nostalgic. Then I rebuilt it in Rails so that I could make it pretty and put it on the internets. If you'd like to play the terminal version, run [this .rb](https://github.com/lortza/tts-ruby-practice/blob/master/myprograms/tarot-refactor.rb) locally, or jump right in to do a reading via [this repl](https://repl.it/@lortz/tarotreadings).

# Tour of The Rails App
Though you can [go here](https://modernmystic.herokuapp.com/) to see a working version of this app (delayed spin-up courtesy of free heroku dynos ;) ), here is an overview of the features.

### Doing Readings
Visitors can select a type of tarot reading from the home page. Those gorgeous purple circles are a little sass magic (`background-image: radial-gradient($gradient-lt 0%, $gradient-dk 60%);`)
![Alt text](/screenshots/home.png?raw=true "Home Page")

But more importantly, when clicked, they take you to a reading show page where you can click on the cards, one at a time, to get a reading. When you first arrive on the reading page, all cards are displayed face-down.
![Alt text](/screenshots/reading_01.png?raw=true "New Reading")

When you click on a card, a modal opens with the card face and an intrepretation of this card in this particular position. In tarot, both the card and the position the card is in carry meanings. You read the two of them together to derive the full meaning.
![Alt text](/screenshots/reading_02.png?raw=true "Seeing a card's interpretation during a reading")

The modal does that for you by zipping the `card` data into the `reading_positions` data and displaying them both together.

```ruby
# app/controllers/readings_controller.rb
...

def show
 positions = @reading.positions.order(:position_number).to_a
 cards = CardFactory.build_cards(positions.count)
 @positioned_cards = positions.zip(cards)
end

...
```

As you dismiss each modal, you see the cards you've already read displayed face up, with the remaining cards displayed face down. As you can see, some of those cards are right-side up and other are upside down -- and it's not just the `css`, there's "upside down" data too. We'll get to the significance of that in a moment.
![Alt text](/screenshots/reading_03.png?raw=true "Seeing read cards as face-up and unread cards as face-down")

Aside from doing readings, visitors can use this app as a tarot knowledge base where they can look up the meanings for each card from the card index page.
![Alt text](/screenshots/card_details.png?raw=true "Sample card from the database with all card data details")

### The Admin Section
As a person who manages the content of this site, I get pretty excited about the less-shiny features like... _the Admin section_. Here, I can see a list of readings, including their `published?` status:
![Alt text](/screenshots/admin_reading_index.png?raw=true "Readings index page")

As you've been seeing, in tarot, a reading has many positions in which to place a card, and each of those positions carries its own meaning (or context) for when you place the card in it. Some readings have only 3 cards, some have 10. So a `reading` `has_many :reading_positions`. Here you see the reading show page with each reading's name and the questions it provides the user to invoke insight:
![Alt text](/screenshots/admin_reading_show.png?raw=true "Reading show page with all reading positions")

^See that nifty `+ Add Position` button? It uses good old `remote: true` to pop open a form on the bottom of the page so I can easily add a new question.

```erb
<div id="new-position-form">
  <%= link_to "+ Add Position", new_admin_reading_reading_position_path(@reading, format: 'js'), remote: true, class: button_classes('success') %>
</div>
```

It also auto-populated the `position_number` integer field with the next appropriate number (even if a number has been skipped), which in this case, is 9:

```ruby
# app/models/reading_position.rb

class ReadingPosition < ApplicationRecord
...

  def set_position_number
    if self.reading.has_positions? && has_skipped_nums?(self)
      self.position_number = next_gap_num(self)
    elsif self.reading.has_positions?
      last_num = reading.positions.pluck(:position_number).sort.last
      self.position_number = last_num + 1
    else
      self.position_number = 1
    end
  end
  ...
```

![Alt text](/screenshots/admin_reading_show_form.png?raw=true "Reading show page with expanded new position form")

Since a reading can have so many positions, I wanted to make sure editing a `reading` _and_ its `positions` could be done in 1 step. That means implementing `accepts_nested_attributes_for`, which makes the form super user-friendly.

```ruby
# app/models/reading.rb

class Reading < ApplicationRecord

  has_many :reading_positions, dependent: :destroy
  has_many :positions, class_name: :ReadingPosition

  accepts_nested_attributes_for :positions,
                                :reject_if => :all_blank,
                                :allow_destroy => true
  ...
```

![Alt text](/screenshots/admin_reading_form.png?raw=true "Nested form for readings with reading_positions")

## App Architecture
This app's architecture is straightforward, with `Card`s, `Reading`s, and `User`s independent of each other's related tables. Thanks [rails-erd](https://github.com/voormedia/rails-erd) for that sweet ERD gem.

![Alt text](/screenshots/erd.png?raw=true "Schema ERD")

### App Architecture Evaluation
RubyCritic says that my Rails app is made mostly of simple files that don't churn often. The outlier dots you see are the `seeds.rb`, `schema.rb`, and `routes.rb`.
![Alt text](/screenshots/rubycritic.png?raw=true "RubyCritic stats")

All of the other dots are in the lower left quadrant, i.e. the [healthy closure region](https://github.com/chad/turbulence#hopefully-meaningful-metrics). I attribute that to single-purpose objects. One of my favorites is the `CardFactory`, which is responsible for generating tarot cards for the readings so that the cards can be either right-side up, or upside down. In tarot, a single card can mean different things depending on its orientation (here's that "upside down data" I was talking about), so I was really excited to implement that feature. So excited, in fact, that I wrote [a blog post about it](http://lortza.github.io/2018/02/26/card-factory.html).

This way, `Card`s don't have to worry about their orientation. All they know is that they have both a `upright_theme` and a `reverse_theme`. And `Reading`s don't have to worry about card orientation. All they know is how to deal out some cards.

The coolest part of the factory is the `build_cards` method where it randomly assigns an `upright` or `reverse` orientation to a card and then uses a little metaprogramming to call the correct attribute from the `Card` model.

```ruby
# app/models/card_factory.rb
...

def self.build_cards(qty)
  raw_cards = Card.all.sample(qty)
  orientation_options = ['reverse', 'upright']
  @built_cards = []

  raw_cards.each do |card|
    orientation = orientation_options.sample
    built_theme = card.send("#{orientation}_theme")
    built_keywords = card.send("#{orientation}_keywords")
    built_name = orientation == 'upright' ? card.name : "Reversed #{card.name}"

    built_card = CardFactory.new(card, built_name, built_theme, built_keywords, orientation)
    @built_cards << built_card
  end
  @built_cards
end

...
```

This kind of metaprogramming is just so delightful to me because it dynamically solves an otherwise clunky manual assignment process. #nerdsquee

The fancy new `card.orientation` attribute generated by the factory comes in handy for the view helpers so the cards can be rendered visually upside down as well.

I could probably talk about this app all day, but I'll just leave it at that. Connect with me if you'd like to know more :)


